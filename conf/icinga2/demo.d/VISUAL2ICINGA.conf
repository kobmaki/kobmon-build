#
# Author: Uwe Ebel ( kobmaki @ aol . com )
# Project: kobmon-build
# License: GPL v2
#
# Visualization of Icinga2
#

# load some required functions
include "../function.d/function.HostParentPathRebuild.conf"
include "../function.d/function.IsObjectDerive.conf"
include "../function.d/function.Keys.conf"

# This is the dictionary that contains all required information
VISUAL2ICINGA = {}

# define types
VISUAL2ICINGA.set("Types",{});

VISUAL2ICINGA.set("Object",{});
VISUAL2ICINGA.set("NoObject",{});

VISUAL2ICINGA.set("ConfigObject",{});
VISUAL2ICINGA.set("NoConfigObject",{});

VISUAL2ICINGA.set("CustomVarObject",{});

# some special objects
VISUAL2ICINGA.set("SPECIALS",{});

# some types for Math, actual numbers, function
VISUAL2ICINGA.set("MathTypes",{});

VISUAL2ICINGA.set("globalsTypes",{});

VISUAL2ICINGA.set("SystemTypes",{});

VISUAL2ICINGA.set("STRUCTURE",{});

# for geo location, icingaweb2-module-map
VISUAL2ICINGA.set("GeoLocation",{
 # nuremberg
 "VISUAL2ICINGA" = "49.425409,11.079655",
 # bangkok
 "System" = "13.756331,100.501765",
 # new york
 "Math" = "40.712784,-74.005941",
 # buenos aires
 "CheckComand" = "-34.603684,-58.381559",
 # london
 "Type" = "51.507351,-0.127758",
 # sydney
 "globals" = "-33.865143,151.209900",
});

# Template for GEOMAP
template Host "template-VISUAL2ICINGA-GEOMAP" {
 # vars.geolocation={{ VISUAL2ICINGA.get("GeoLocation").get(vars.ityp) }}
}

# Template for usage, include geomap
template Host "template-VISUAL2ICINGA" {
  address = "127.0.0.1"
  check_command = "dummy"
  vars.host_parents = []
#  vars.host_parent_path = ""
  vars.templates_count = templates.len();
  vars.visual2icinga = "VISUAL2ICINGA";

  if (name != "VISUAL2ICINGA" && vars.ityp != "STRUCTURE") {
    vars.ityp=name.reverse().split(".")[0].reverse()
  }

 import "template-VISUAL2ICINGA-GEOMAP"

 vars.geolocation = VISUAL2ICINGA.get("GeoLocation").get(vars.ityp)

}

#
# Special Elements
#
for ( x in ["Object","ConfigObject","CustumVarObject"]) {
  VISUAL2ICINGA.get("STRUCTURE").set(x,true);
}

for ( x in ["Type","System","Math","globals","STRUCTURE"]) {
  VISUAL2ICINGA.get("SPECIALS").set(x,true);
}

#
#
#
for ( x in  globals.keys() ) {
  VISUAL2ICINGA.get("Types").set(typeof(globals.get(x)).name,true)
}

#
# All types from globals
#
for (x in keys(globals)) {
  VISUAL2ICINGA.get("globalsTypes").set(typeof(globals.get(x)).name,true)
}

#
# All type from Math
#
for (x in keys(Math)) {
  VISUAL2ICINGA.get("MathTypes").set(typeof(Math.get(x)).name,true)
}

#
# All types from System
#
for (x in keys(System)) {
  VISUAL2ICINGA.get("SystemTypes").set(typeof(System.get(x)).name,true)
}


for ( x in Types.keys() ) {

    var y = Types.get(x);

    if ( IsObjectDerive(y, Object) ) {
       VISUAL2ICINGA.get("Object").set(x,true);
    }

    if ( IsObjectDerive(y, ConfigObject) ) {
       VISUAL2ICINGA.get("ConfigObject").set(x,true);
    }

    if ( IsObjectDerive(y, CustomVarObject) ) {
       VISUAL2ICINGA.get("CustomVarObject").set(x,true);
    }

    if ( ! IsObjectDerive(y, ConfigObject) ) {
       VISUAL2ICINGA.get("NoConfigObject").set(x,true);
    }

   if ( ! IsObjectDerive(y, Object) ) {
      VISUAL2ICINGA.get("NoObject").set(x,true);
   }

}

#
# The root object for VISUAL2ICINGA
#
object Host "VISUAL2ICINGA" {
  import "template-VISUAL2ICINGA"
  vars.ityp="STRUCTURE"
}


#
# Define the structure and hostgroup
#
for ( x in VISUAL2ICINGA.get("SPECIALS").keys() ) {

  object Host x+".ICINGA2" {
    import "template-VISUAL2ICINGA"
    vars.ityp="STRUCTURE"
    vars.host_parents=["VISUAL2ICINGA"];
  }

  object HostGroup "VISUAL2ICINGA-"+x use(x) {
       display_name = "VISUAL2ICINGA "+x
       assign where match(host.vars.ityp, x );
 }

}

#
# create globals structure
#
for ( x in VISUAL2ICINGA.get("globalsTypes").keys() ) {
  object Host x+".globals" {
    import "template-VISUAL2ICINGA"
    vars.ityp="STRUCTURE"
    vars.host_parents=["globals.ICINGA2"];
  }
}

#
# globals objects
#

for ( i in globals.keys() ) {
  object Host i+".globals" use(i) {
    import "template-VISUAL2ICINGA"
    display_name = i+" (globals)"
    vars.ityp_sub=typeof(globals.get(i)).name
    vars.ityp_keys=[]
    if (vars.ityp_sub=="Dictionary" || vars.ityp_sub=="Array") {
      vars.ityp_keys=Keys(globals.get(i))
    }
    vars.host_parents=[typeof(globals.get(i)).name+".globals"]
  }
}



for ( aType in VISUAL2ICINGA.get("Types").keys() ) {

  object Host aType+".ICINGA2" use (aType) {
    import "template-VISUAL2ICINGA"
    vars.host_parents = [ "VISUAL2ICINGA" ]
    vars.ityp_sub=aType
  }

  object HostGroup "VISUAL2ICINGA-"+aType use(aType) {
       display_name = "VISUAL2ICINGA "+aType
       assign where match(aType,host.vars.ityp_sub)
 }

}

#
# types object
#
for ( aType in keys(Types) ) {

  object Host aType+".Type" use(aType) {
           import "template-VISUAL2ICINGA"
           display_name = name+" "+aType+" (Type)"
	   vars.ityp="Type"
	   vars.ityp_sub=typeof(Types.get(aType)).name

           if ( Types.get(aType).base.name ) {
              vars.host_parents += [ Types.get(aType).base.name+".Type" ]
           }

           if ( ! Types.get(aType).base.name ) {
              vars.host_parents += [ "Type.ICINGA2" ]
           }

           if (IsObjectDerive(Types.get(aType),"ConfigObject")) {
	          vars.ityp_count=get_objects(Types.get(aType)).len(); # function len() from ConfigObject
           }
	    
    }
}

#
# System
#

for ( i in keys(System)) {
  object Host i+".System" use(i) {
     import "template-VISUAL2ICINGA"
     display_name= i+" (System)"
     vars.host_parents+=["System.ICINGA2"]
     vars.system_type=typeof(System.get(i)).name
     vars.ityp_sub=typeof(System.get(i)).name
    }

}

#
# Math
#

for (x in VISUAL2ICINGA.get("MathTypes").keys()) {
  object Host x+".Math" use(x) {
     import "template-VISUAL2ICINGA"
     display_name= x+" Math"
     vars.ityp="STRUCTURE"
     vars.host_parents+=["Math.ICINGA2"]
  }
}


for ( i in keys(Math)) {
  object Host i+".Math" use(i) {
     import "template-VISUAL2ICINGA"
     display_name= i+" (Math)"
     vars.host_parents+=[typeof(Math.get(i)).name+".Math"]
     vars.math_type=typeof(Math.get(i)).name
     vars.ityp_sub=typeof(Math.get(i)).name
     if (vars.ityp_sub=="Dictionay" || vars.ityp_sub=="Array") {
        vars.ityp_keys=Keys(Math.get(i))
     }
  }
}

#
# The following two loop for object contruction doens't work
# as the get_objects() is empty. This is for TimePeriod, CheckCommand

#
# TimePeriod
#

for ( q in range(System.get_objects(TimePeriod).len())) {
  var aTP=get_objects(TimePeriod)[q]
  object Host aTP.name+".TimePeriod" use(aTP) {
    import "template-VISUAL2ICINGA"
    display_name = aTP.name+" (TimePeriod)"
    vars.host_parents+=[ "TimePeriod.ICINGA2"]
    vars.templates=aTP.templates
  }
}

#
# CheckCommand
#

for ( y in get_objects(CheckCommand)) {
  object Host y.name+".CheckCommand" use(y) {
    import "template-VISUAL2ICINGA"
    display_name = y.name+" (CheckCommand)"
    vars.ityp = CheckCommand.name
    vars.templates = y.templates
    vars.host_parents+=[ CheckCommand.name+".Type"]
  }
}

#
# Dependency set
#

apply Dependency "XHostParent." for (aHost in host.vars.host_parents) to Host {
#  import "generic-dependency"
  parent_host_name = aHost;
  disable_checks = false;
  assign where host.vars.host_parents;
  ignore where match(aHost,"");
  ignore where ! get_object(Host,aHost);
}

#
# Calculate the host_parent_path
#
apply Dependency "ParentPathRebuild" to Host {
 HostParentPathRebuild();
 assign where host.name=="VISUAL2ICINGA";
}
